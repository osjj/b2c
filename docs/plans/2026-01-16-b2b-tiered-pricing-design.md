# B2B 批量阶梯价格功能设计

## 概述

为 B2B 模式添加批量阶梯价格功能，允许管理员为每个产品设置不同数量区间的单价，系统自动根据购买数量计算价格，同时保留客户议价空间。

## 需求决策

| 项目 | 决定 |
|------|------|
| 适用范围 | 按产品独立设置 |
| 定价方式 | 固定单价 |
| 前端应用 | 自动计算 + 可议价 |
| 阶梯数量 | 最多5个，数量不固定 |
| 最小起订量 | 不需要 |
| 后台配置 | 产品编辑页内嵌 |
| 生效范围 | 仅 B2B 模式 |

## 数据模型

### 新增 PriceTier 模型

```prisma
model PriceTier {
  id          String   @id @default(cuid())
  productId   String
  minQuantity Int      // 起始数量，如 1、11、51
  maxQuantity Int?     // 结束数量，null 表示"及以上"
  price       Decimal  @db.Decimal(10, 2)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("price_tiers")
}
```

### 修改 Product 模型

```prisma
model Product {
  // ... 现有字段
  priceTiers PriceTier[]
}
```

### 修改 Quote 模型

```prisma
model Quote {
  // ... 现有字段
  expectedPrice Decimal? @db.Decimal(10, 2) // 客户期望价格（可选）
}
```

### 规则说明

- 阶梯之间的数量范围必须连续且不重叠
- 第一个阶梯的 `minQuantity` 通常为 1
- 最后一个阶梯的 `maxQuantity` 为 null，表示"XX件及以上"
- 如果产品没有配置阶梯价格，则使用产品的标准 `price` 字段

## 后台管理界面

在产品编辑页的价格区域下方添加「阶梯价格」配置模块：

```
┌─────────────────────────────────────────────────┐
│ 阶梯价格（B2B批量定价）              [+ 添加阶梯] │
├─────────────────────────────────────────────────┤
│  数量范围          单价              操作        │
│  ┌────┐ ~ ┌────┐   ┌────────┐       [删除]     │
│  │ 1  │   │ 10 │   │ ¥100   │                  │
│  └────┘   └────┘   └────────┘                  │
│  ┌────┐ ~ ┌────┐   ┌────────┐       [删除]     │
│  │ 11 │   │ 50 │   │ ¥90    │                  │
│  └────┘   └────┘   └────────┘                  │
│  ┌────┐ ~ 及以上    ┌────────┐       [删除]     │
│  │ 51 │             │ ¥80    │                  │
│  └────┘             └────────┘                  │
└─────────────────────────────────────────────────┘
```

### 交互逻辑

- 点击「添加阶梯」新增一行（最多5个）
- 最后一个阶梯的结束数量自动显示为「及以上」
- 保存时校验：数量必须递增、价格必须递减（或至少不增加）、范围不能有间隙
- 如果不添加任何阶梯，B2B 模式下使用标准单价

## 前端产品展示

### 产品详情页（B2B模式）

```
┌─────────────────────────────────────────────────┐
│ 产品名称                                         │
│                                                  │
│ 批量价格                                         │
│ ┌─────────────────────────────────────────────┐ │
│ │  数量          单价           节省           │ │
│ │  1-10件        ¥100/件        -             │ │
│ │  11-50件       ¥90/件         10%           │ │
│ │  51件及以上    ¥80/件         20%    ← 推荐  │ │
│ └─────────────────────────────────────────────┘ │
│                                                  │
│ 数量: [ - ]  10  [ + ]                          │
│                                                  │
│ 当前单价: ¥100    小计: ¥1,000                  │
│                                                  │
│ 💡 再加 1 件即可享受 ¥90/件 的优惠价             │
│                                                  │
│ [        加入询价单        ]                     │
└─────────────────────────────────────────────────┘
```

### 交互细节

- 阶梯价格表常驻显示，当前命中的阶梯高亮
- 数量变化时实时更新单价和小计
- 智能提示：如果接近下一阶梯，显示"再加X件可享受更优价格"
- 产品卡片上显示"¥80起"（最低阶梯价）而非固定单价

## 询价流程集成

### 询价单展示

```
┌─────────────────────────────────────────────────┐
│ 询价单 (3件商品)                                 │
├─────────────────────────────────────────────────┤
│ [图] 产品A                                       │
│     数量: 25件  ×  ¥90/件  =  ¥2,250            │
│     (11-50件阶梯价)                              │
│                                                  │
│ [图] 产品B                                       │
│     数量: 100件  ×  ¥50/件  =  ¥5,000           │
│     (51件及以上阶梯价)                           │
├─────────────────────────────────────────────────┤
│ 预估总计: ¥7,250                                 │
│                                                  │
│ 期望价格或备注（选填）                           │
│ ┌─────────────────────────────────────────────┐ │
│ │ 长期合作客户，希望能给个更优惠的价格...      │ │
│ └─────────────────────────────────────────────┘ │
│                                                  │
│ [          提交询价          ]                   │
└─────────────────────────────────────────────────┘
```

### 数据保存

- `QuoteItem` 记录提交时的阶梯单价（`price` 字段已有）
- 新增 `Quote.expectedPrice` 字段保存客户的期望价格（可选）
- 管理员在后台可看到自动计算价格和客户期望价格，便于议价

## 技术实现

### 需要修改的文件

| 层级 | 文件/内容 | 说明 |
|------|----------|------|
| 数据库 | `prisma/schema.prisma` | 新增 `PriceTier` 模型 |
| 后台 | `src/app/admin/products/[id]/page.tsx` | 产品编辑页添加阶梯价格配置 |
| 后台 | `src/actions/products.ts` | 产品保存时处理阶梯价格 |
| 前端 | `src/app/(store)/products/[slug]/page.tsx` | 产品详情页展示阶梯价格表 |
| 前端 | `src/components/store/product-card.tsx` | 显示"¥XX起"最低价 |
| 前端 | `src/components/store/add-to-quote-button.tsx` | 传递阶梯价格 |
| 前端 | `src/components/store/mini-quote.tsx` | 显示阶梯价格明细 |
| 数据库 | `Quote` 模型 | 新增 `expectedPrice` 字段 |

### 新增工具函数

```typescript
// lib/pricing.ts

/**
 * 根据数量计算阶梯单价
 */
function calculateTierPrice(priceTiers: PriceTier[], quantity: number, defaultPrice: number): number

/**
 * 获取下一阶梯提示信息
 */
function getNextTierHint(priceTiers: PriceTier[], quantity: number): {
  hasNextTier: boolean
  quantityNeeded: number
  nextPrice: number
  savingsPercent: number
} | null
```

### 条件判断

所有阶梯价格逻辑仅在 `NEXT_PUBLIC_PROJECT_TYPE === 'B2B'` 时生效。

## 验收标准

1. 管理员可以在产品编辑页配置1-5个阶梯价格
2. B2B模式下产品详情页正确展示阶梯价格表
3. 数量变化时自动计算并显示对应阶梯价格
4. 接近下一阶梯时显示智能提示
5. 产品卡片显示"¥XX起"格式的最低价
6. 询价单正确应用阶梯价格
7. 客户可以填写期望价格进行议价
8. B2C模式下不显示阶梯价格功能
